<h1 class="text-2xl font-semibold mb-4">Registrar Consulta Médica</h1>

<!-- Loading -->
<div *ngIf="loadingAppointment" class="text-center py-8">
  <p class="text-gray-600">Cargando datos de la cita...</p>
</div>

<!-- Error -->
<div *ngIf="error && !loadingAppointment" class="bg-red-50 border border-red-200 text-red-800 p-4 rounded mb-4">
  <p>{{ error }}</p>
  <button 
    class="mt-2 px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
    routerLink="/doctor/appointments"
  >
    Volver a citas
  </button>
</div>

<!-- Datos del paciente -->
<div *ngIf="appointment && !loadingAppointment" class="space-y-6">
  
  <!-- Info de la cita -->
  <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
    <h3 class="font-semibold text-lg mb-2 text-blue-900">Datos del Paciente</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
      <div>
        <span class="font-medium text-gray-700">Nombre:</span>
        <span class="ml-2">{{ appointment.patient.first_name }} {{ appointment.patient.last_name }}</span>
      </div>
      <div>
        <span class="font-medium text-gray-700">DNI:</span>
        <span class="ml-2">{{ appointment.patient.dni }}</span>
      </div>
      <div>
        <span class="font-medium text-gray-700">Edad:</span>
        <span class="ml-2">{{ appointment.patient.age || 'N/A' }}</span>
      </div>
      <div>
        <span class="font-medium text-gray-700">Teléfono:</span>
        <span class="ml-2">{{ appointment.patient.phone || 'N/A' }}</span>
      </div>
      <div class="md:col-span-2">
        <span class="font-medium text-gray-700">Fecha de Cita:</span>
        <span class="ml-2">{{ appointment.date | date:'short' }}</span>
      </div>
      <div class="md:col-span-2" *ngIf="appointment.reason">
        <span class="font-medium text-gray-700">Motivo de consulta:</span>
        <span class="ml-2">{{ appointment.reason }}</span>
      </div>
    </div>
  </div>

  <!-- Formulario de consulta -->
  <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-4 bg-white p-6 rounded-lg shadow">
    
    <h3 class="font-semibold text-lg mb-4 text-gray-900">Registro de Consulta</h3>

    <!-- Diagnóstico -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">
        Diagnóstico *
      </label>
      <textarea
        formControlName="diagnosis"
        placeholder="Describa el diagnóstico del paciente"
        rows="4"
        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
        [class.border-red-500]="form.get('diagnosis')?.invalid && form.get('diagnosis')?.touched"
      ></textarea>
      <p 
        *ngIf="form.get('diagnosis')?.invalid && form.get('diagnosis')?.touched" 
        class="text-red-600 text-sm mt-1"
      >
        El diagnóstico es obligatorio
      </p>
    </div>

    <!-- Observaciones -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">
        Observaciones Adicionales
      </label>
      <textarea
        formControlName="observations"
        placeholder="Observaciones adicionales (opcional)"
        rows="3"
        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
      ></textarea>
    </div>

    <!-- Tratamiento -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">
        Tratamiento *
      </label>
      <textarea
        formControlName="treatment"
        placeholder="Indique el tratamiento a seguir"
        rows="4"
        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
        [class.border-red-500]="form.get('treatment')?.invalid && form.get('treatment')?.touched"
      ></textarea>
      <p 
        *ngIf="form.get('treatment')?.invalid && form.get('treatment')?.touched" 
        class="text-red-600 text-sm mt-1"
      >
        El tratamiento es obligatorio
      </p>
    </div>

    <!-- Botones -->
    <div class="flex gap-3 pt-4">
      <button 
        type="submit" 
        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium"
        [disabled]="form.invalid || submitting"
        [class.opacity-50]="form.invalid || submitting"
        [class.cursor-not-allowed]="form.invalid || submitting"
      >
        {{ submitting ? 'Guardando...' : '✅ Guardar Consulta' }}
      </button>
      
      <button 
        type="button" 
        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-medium"
        routerLink="/doctor/appointments"
        [disabled]="submitting"
      >
        Cancelar
      </button>
    </div>

  </form>

</div>