<div class="min-h-screen bg-gray-100 flex items-center justify-center p-6">
  
  <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-teal-500 to-blue-600 text-white p-6 rounded-t-lg">
      <div class="flex items-center gap-3 mb-2">
        <button 
          (click)="goBack()"
          class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <h1 class="text-2xl font-bold">Firmar Historia Cl√≠nica</h1>
      </div>
      <p class="text-teal-100 mt-1" *ngIf="clinicalHistory">
        Paciente: {{ clinicalHistory.patient?.first_name }} {{ clinicalHistory.patient?.last_name }}
      </p>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="p-12 text-center">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mb-4"></div>
      <p class="text-gray-600">Cargando datos...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error && !loading" class="p-6">
      <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
        <p class="text-red-600">{{ error }}</p>
      </div>
      <button 
        (click)="goBack()"
        class="mt-4 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
        Volver
      </button>
    </div>

    <!-- Contenido Principal -->
    <div *ngIf="clinicalHistory && !loading" class="p-6 space-y-6">
      
      <!-- Resumen de Historia Cl√≠nica -->
      <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
        <h3 class="font-semibold text-lg mb-3 text-blue-900">Resumen de la Consulta</h3>
        <div class="space-y-2 text-sm">
          <div><strong>Diagn√≥stico:</strong> {{ clinicalHistory.diagnosis }}</div>
          <div *ngIf="clinicalHistory.consultation?.treatment">
            <strong>Tratamiento:</strong> {{ clinicalHistory.consultation?.treatment }}
          </div>
          <div>
            <strong>Fecha:</strong> {{ clinicalHistory.created_at | date:'dd/MM/yyyy HH:mm' }}
          </div>
        </div>
      </div>

      <!-- ‚≠ê NUEVO: Selector de M√©todo de Firma -->
      <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Seleccione el m√©todo de firma:</h3>
        <div class="flex gap-3">
          <button
            (click)="changeSignatureMethod('upload')"
            [class.ring-4]="signatureMethod === 'upload'"
            [class.ring-purple-500]="signatureMethod === 'upload'"
            [class.bg-purple-600]="signatureMethod === 'upload'"
            [class.text-white]="signatureMethod === 'upload'"
            [class.bg-white]="signatureMethod !== 'upload'"
            [class.text-gray-700]="signatureMethod !== 'upload'"
            class="flex-1 px-4 py-3 border-2 border-purple-300 rounded-lg hover:border-purple-500 transition font-medium flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Subir Imagen (JPG/PNG)
          </button>
          
          <button
            (click)="changeSignatureMethod('draw')"
            [class.ring-4]="signatureMethod === 'draw'"
            [class.ring-teal-500]="signatureMethod === 'draw'"
            [class.bg-teal-600]="signatureMethod === 'draw'"
            [class.text-white]="signatureMethod === 'draw'"
            [class.bg-white]="signatureMethod !== 'draw'"
            [class.text-gray-700]="signatureMethod !== 'draw'"
            class="flex-1 px-4 py-3 border-2 border-teal-300 rounded-lg hover:border-teal-500 transition font-medium flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
            </svg>
            Dibujar con Mouse
          </button>
        </div>
      </div>

      <!-- ‚≠ê M√âTODO 1: Subir Imagen -->
      <div *ngIf="signatureMethod === 'upload'" class="border-2 border-dashed border-purple-300 rounded-lg p-6 bg-purple-50">
        <label class="block text-sm font-medium text-gray-700 mb-3">
          üì∑ Suba una imagen de su firma (JPG o PNG):
        </label>
        
        <!-- Input oculto para archivo -->
        <input 
          #fileInput
          type="file" 
          accept="image/jpeg,image/jpg,image/png"
          (change)="onFileSelected($event)"
          class="hidden">
        
        <!-- Bot√≥n de subir -->
        <button
          type="button"
          (click)="triggerFileInput()"
          class="w-full px-6 py-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:from-purple-600 hover:to-purple-700 transition font-medium flex items-center justify-center gap-3 shadow-lg hover:shadow-xl">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Click para seleccionar imagen
        </button>
        
        <p class="text-xs text-gray-500 mt-2 text-center">
          Formatos permitidos: JPG, PNG ‚Ä¢ Tama√±o m√°ximo: 2MB
        </p>
      </div>

      <!-- ‚≠ê M√âTODO 2: Dibujar con Canvas -->
      <div *ngIf="signatureMethod === 'draw'" class="border-2 border-dashed border-teal-300 rounded-lg p-4 bg-teal-50">
        <label class="block text-sm font-medium text-gray-700 mb-3">
          ‚úçÔ∏è Dibuje su firma con el mouse o touch:
        </label>
        
        <div class="bg-white border-2 border-gray-400 rounded-lg overflow-hidden">
          <canvas 
            #signatureCanvas
            (mousedown)="startDrawing($event)"
            (mousemove)="draw($event)"
            (mouseup)="stopDrawing()"
            (mouseleave)="stopDrawing()"
            (touchstart)="startDrawing($event)"
            (touchmove)="draw($event)"
            (touchend)="stopDrawing()"
            class="cursor-crosshair w-full"
            width="700"
            height="200">
          </canvas>
        </div>

        <div class="flex justify-end gap-3 mt-3">
          <button 
            type="button"
            (click)="clearSignature()"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm font-medium">
            üóëÔ∏è Limpiar
          </button>
        </div>
      </div>

      <!-- Vista previa de la firma -->
      <div *ngIf="signatureDataUrl" class="bg-gradient-to-br from-green-50 to-teal-50 border-2 border-green-300 p-6 rounded-lg">
        <h4 class="text-sm font-semibold text-green-800 mb-3 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Vista previa de la firma:
        </h4>
        <div class="bg-white p-4 rounded-lg border-2 border-green-200 flex justify-center">
          <img [src]="signatureDataUrl" alt="Firma" class="max-w-md max-h-32 object-contain">
        </div>
        <button
          type="button"
          (click)="clearSignature()"
          class="mt-3 w-full px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-medium">
          ‚ùå Cambiar firma
        </button>
      </div>

      <!-- Mensaje de error -->
      <div *ngIf="submitError" class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
        <p class="text-red-600">{{ submitError }}</p>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="flex gap-3 pt-4 border-t">
        <button 
          type="button"
          (click)="goBack()"
          class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
          Cancelar
        </button>
        
        <button 
          (click)="saveSignature()"
          [disabled]="!signatureDataUrl || submitting"
          class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg">
          <span *ngIf="!submitting">‚úçÔ∏è Firmar y Guardar</span>
          <span *ngIf="submitting">Guardando...</span>
        </button>
      </div>

      <!-- Nota informativa -->
      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded text-sm">
        <p class="text-yellow-800">
          <strong>‚ö†Ô∏è Importante:</strong> Una vez firmada, la historia cl√≠nica no podr√° ser modificada y podr√° ser descargada en formato PDF.
        </p>
      </div>

    </div>
  </div>
</div>